<!DOCTYPE html>
<html data-ng-app="app">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link  rel="stylesheet/less" type="text/css" href="resources/static/css/styles.less">

    <script>
        var less = {
            env: "development"
        };
    </script>

    <script src="resources/static/js/vendor/fabric.js" type="application/javascript" ></script>
    <script src="resources/static/js/vendor/jquery-2.1.1.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/sock.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/vertxbus-2.1.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/angular.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/bootstrap.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/less.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/angular-vertxbus.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/select.js" type="application/javascript"></script>
    <script src="resources/static/js/vendor/showErrors.js" type="application/javascript"></script>

    <script type="application/javascript">
        var app = angular.module('app', ['knalli.angular-vertxbus', "ui.select", "ui.bootstrap.showErrors"]);

        app.controller('chatController', ["$scope", "$rootScope", "vertxEventBusService", function ($scope, $rootScope, vertxEventBusService) {
            var _self = this;
            var username = "czesław";
            var group = "red";
            var users = [
                {username: "czesio", team: "Red"},
                {username: "wiesio", team: "Red"},
                {username: "stasia", team: "Blue"}
            ];

            var eb = vertxEventBusService;
            var g_messages = [];
            var chat_scope = null;
            _self.logged = false;


            var createEmptyMessage = function () {
                return {from: username, message: "", class: "normal", date: null};
            };

            function scrollChatWindow() {
                var $messageList = $('#messageList');
                $messageList.scrollTop($messageList.find('ul').height());
            }

            this.messages = g_messages;
            var message = $scope.message = createEmptyMessage();
            chat_scope = $scope;

            $scope.users = users;

            $scope.send = function () {
                var address = 'chat.message';
                if (message.message.indexOf('/whisper ') == 0) {
                    message.message = message.message.substring(9);
                    var to = message.message.substring(0, message.message.indexOf(' '));
                    message.message = message.message.substring(message.message.indexOf(' '));
                    address = 'chat.message.' + to;
                    message.class = "toWhisper";
                    message.date = new Date();

                    var cloned = {};
                    angular.copy(message, cloned);
                    cloned.from = "Whisper to: " + to;
                    g_messages.push(cloned);
                }

                if (message.message.indexOf('/group') == 0) {
                    message.message = message.message.substring(6);
                    address = 'chat.message.' + group;
                }

                eb.publish(address, message);
                $scope.message = message = createEmptyMessage();
                setTimeout(function() { // hack :/
                    scrollChatWindow();
                }, 10);
            };

            $scope.usernameClicked = function (user) {
                message.message = '/whisper ' + user.username + ' ';
                $('#msg').focus();
            }

            var handleMsg = function (msg) {
                msg.date = new Date();
                g_messages.push(msg);
                chat_scope.$apply();
                scrollChatWindow();
            };

            eb.addListener("chat.message", function (msg) {
                handleMsg(msg);
            });

            eb.addListener("chat.message." + username, function (msg) {
                msg.class = "whisper";
                handleMsg(msg);
            });

            eb.addListener("chat.message." + group, function (msg) {
                msg.class = "group";
                handleMsg(msg);
            });

            $rootScope.$on("logged", function() {
                _self.logged = true;
            });

            $rootScope.$on("disconnected", function() {
                _self.logged = false;
            });
        }]);


        $(document).ready(function () {
            $(window).keyup(function (event) {
                var msgInput = $('#msg');
                if (event.keyCode == 84) {
                    msgInput.focus();
                }

                if (event.keyCode == 27 && msgInput.is(":focus")) {
                    msgInput.blur();
                }
            });
        });
    </script>

    <script src="resources/static/js/login.js" type="application/javascript"></script>
    <script src="resources/static/js/board.js" type="application/javascript"></script>
</head>
<body>
<div id="chat" data-ng-controller="chatController as cnt" data-ng-show="cnt.logged">
    <div id="usersWrapper">
        <div class="usersList">
            <h3>Users</h3>
            <ul class="chatList">
                <li data-ng-repeat="user in users" ng-click="usernameClicked(user)" class="{{ user.team }}">{{
                    user.username }} ({{ user.team }})
                </li>
            </ul>
        </div>
    </div>
    <div id="chatWrapper">
        <div class="chatBox">
            <h3>Chat</h3>

            <div id="messageList">
                <ul class="chatList">
                    <li data-ng-repeat="msg in cnt.messages" ng-class="msg.class"><strong>{{ msg.from }} ({{ msg.date |
                        date:'mediumTime' }})</strong> {{ msg.message }}
                    </li>
                </ul>
            </div>
            <div id="sendForm">
                <form ng-submit="send()">
                    <input type="text" data-ng-model="message.message" id="msg"><br>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="board" data-ng-controller="gameController as cnt" data-ng-show="cnt.logged">
    <canvas id="gameVisualisation">
        Your browser does not support Canvas element. Shame on you!
    </canvas>
    <img src="resources/static/img/fighter.png" id="plane" class="boardImage" />
    <img src="resources/static/img/missile.png" id="missile" class="boardImage" />
</div>

<div id="loginContainer" data-ng-controller="loginController as cnt" class="container">
    <form name="loginForm" id="loginForm" data-ng-hide="cnt.logged" role="form" class="form-horizontal" novalidate>
        <div class="col-sm-6 col-sm-offset-3">
            <div>
                <label for="login" class="col-sm-2 control-label">Login</label>
                <div class="col-sm-10 form-group" show-errors>
                    <input class="form-control" placeholder="enter login here..." name="login" id="login" data-ng-model="cnt.user.login" ng-minlength="3" required/>
                    <span class="error help-block" ng-show="loginForm.login.$error.minlength">Too short!</span>
                </div>
            </div>
            <br/>

            <div>
                <label for="group" class="col-sm-2 control-label">Group</label>
                <div class="col-sm-10 form-group">
                    <ui-select name="group" id="group" ng-model="cnt.user.group" theme="bootstrap" ng-disabled="disabled" reset-search-input="false">
                        <ui-select-match placeholder="select group...">{{$select.selected}}</ui-select-match>
                        <ui-select-choices repeat="group in cnt.available_groups">
                            {{group}}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
            <div class="col-sm-10 col-sm-offset-2">
                <div class="form-group">
                    <button class="btn btn-default" data-ng-click="cnt.connect(cnt.user)" type="submit" data-ng-disabled="loginForm.$invalid">Login</button>
                </div>
            </div>
        </div>
    </form>

    <div>
        <button class="btn btn-default" data-ng-click="cnt.logout()" type="submit" data-ng-show="cnt.logged">Logout</button>
    </div>

    </div>

</div>
</body>
</html>