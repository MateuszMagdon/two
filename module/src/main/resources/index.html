<!DOCTYPE html>
<html data-ng-app="chat">
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="/style.css">
    <script src="/jquery.js"></script>
    <script src="/sock.js"></script>
    <script type="application/javascript" src="/vertxbus.js"></script>
    <script type="application/javascript"
            src="/angular.js"></script>

    <script type="application/javascript">
        var chat = angular.module('chat', []);

        var username = "czes≈Çaw";
        var group = "red";
        var users = [
            {username: "czesio", team: "Red"},
            {username: "wiesio", team: "Red"},
            {username: "stasia", team: "Blue"}
        ];

        var eb = null;
        var g_messages = [];
        var chat_scope = null;

        eb = new vertx.EventBus(document.location.href + "eventbus");

        var createEmptyMessage = function () {
            return {from: username, message: "", class: "normal", date: null};
        };

        chat.controller('chatController', function ($scope) {
            this.messages = g_messages;
            var message = $scope.message = createEmptyMessage();
            chat_scope = $scope;

            $scope.users = users;

            $scope.send = function () {
                var address = 'chat.message';
                if (message.message.indexOf('/whisper ') == 0) {
                    message.message = message.message.substring(9);
                    var to = message.message.substring(0, message.message.indexOf(' '));
                    message.message = message.message.substring(message.message.indexOf(' '));
                    address = 'chat.message.' + to;
                    message.class = "toWhisper";
                    message.date = new Date();

                    var cloned = {};
                    angular.copy(message, cloned);
                    cloned.from = "Whisper to: " + to;
                    g_messages.push(cloned);
                }

                if (message.message.indexOf('/group') == 0) {
                    message.message = message.message.substring(6);
                    address = 'chat.message.' + group;
                }

                eb.publish(address, message);
                $scope.message = message = createEmptyMessage();
            };

            $scope.usernameClicked = function (user) {
                message.message = '/whisper ' + user.username + ' ';
                $('#msg').focus();
            }
        });

        eb.onopen = function () {
            var handleMsg = function (msg) {
                msg.date = new Date();
                g_messages.push(msg);
                chat_scope.$apply();
                $('#messageList').scrollTop($('#messageList').height());
            };
            eb.registerHandler("chat.message", function (msg) {
                handleMsg(msg);
            });

            eb.registerHandler("chat.message." + username, function (msg) {
                msg.class = "whisper";
                handleMsg(msg);
            });

            eb.registerHandler("chat.message." + group, function (msg) {
                msg.class = "group";
                handleMsg(msg);
            });
        };

        eb.onclose = function () {
            eb = null;
        };

        $(document).ready(function() {
           $(window).keyup(function(event) {
               var msgInput = $('#msg');
               if(event.keyCode == 84) {
                    msgInput.focus();
                }

               if(event.keyCode == 27 && msgInput.is(":focus")) {
                   msgInput.blur();
               }
            });
        });
    </script>

</head>
<body>
<div id="chat" data-ng-controller="chatController as cnt">
    <div id="usersWrapper">
        <div class="usersList">
            <h3>Users</h3>
            <ul class="chatList">
                <li data-ng-repeat="user in users" ng-click="usernameClicked(user)" class="{{ user.team }}">{{
                    user.username }} ({{ user.team }})
                </li>
            </ul>
        </div>
    </div>
    <div id="chatWrapper">
        <div class="chatBox">
            <h3>Chat</h3>
            <ul id="messageList" class="chatList">
                <li data-ng-repeat="msg in cnt.messages" ng-class="msg.class"><strong>{{ msg.from }} ({{ msg.date |
                    date:'mediumTime' }})</strong> {{ msg.message }}
                </li>
            </ul>
            <div id="sendForm">
                <form ng-submit="send()">
                    <input type="text" data-ng-model="message.message" id="msg"><br>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>