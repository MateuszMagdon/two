<!DOCTYPE html>
<html data-ng-app="chat">
<head>
    <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script type="application/javascript" src="/vertxbus.js"></script>
    <script type="application/javascript"
            src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular.min.js"></script>

    <script type="application/javascript">
        var chat = angular.module('chat', []);

        var eb = null;
        var g_messages = [{from: "ASD", message: "msg1"}];
        var chat_scope = null;

        eb = new vertx.EventBus(document.location.href+"eventbus");

        chat.controller('chatController', function ($scope) {
            this.messages = g_messages;
            this.user = { login: "", group: "red" };
            var message = this.msg = {from: "me", message: "example"}
            chat_scope = $scope;

            this.send = function () {
                eb.publish('newChatMessage', message);
                message.message = '';
            };

            this.connect = function(user) {
                eb.publish("connect", {'user': user.login, 'group': user.group});
            }
        });

        eb.onopen = function () {
            eb.registerHandler("newChatMessage", function (msg) {
                g_messages.unshift(msg);
                chat_scope.$apply();
            })
        };

        eb.onclose = function () {
            eb = null;
        };
    </script>

</head>
<body>
<div id="chat" data-ng-controller="chatController as cnt">
    <h1>Login</h1>

    <form name="loginForm" >
        <label for="login">Login:</label>
        <input name="login" id="login" data-ng-model="cnt.user.login"/>
        <label for="group">Group:</label>
        <select name="group" id="group" data-ng-model="cnt.user.group">
            <option selected="selected" value="red">red</option>
            <option value="blue">blue</option>
        </select>
        <button data-ng-click="cnt.connect(cnt.user)">Login</button>
    </form>

</div>
</body>
</html>